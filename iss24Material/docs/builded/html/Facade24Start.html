
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Facade24Start &#8212; iss24 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="RobotFacade24" href="RobotFacade24.html" />
    <link rel="prev" title="BasicRobot24" href="BasicRobot24.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="RobotFacade24.html" title="RobotFacade24"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="BasicRobot24.html" title="BasicRobot24"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">iss24 1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Facade24Start</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="facade24start">
<h1>Facade24Start<a class="headerlink" href="#facade24start" title="Permalink to this heading">¶</a></h1>
<p><span class="slide3">progetto Facade24Start</span> (<code class="docutils literal notranslate"><span class="pre">Fcd24S</span></code>)</p>
<p>Lo scopo di questo lavoro è usare <a class="reference external" href="https://spring.io/projects/spring-boot">SpringBoot</a>  per costruire lo <span class="slide2">schema di una applicazione Web</span> (<code class="docutils literal notranslate"><span class="pre">Fcd24S</span></code>) che fornisca una
Web-GUI per l’interfacciamento con applicazioni qak.</p>
<p>Procederemo in due passi:</p>
<ol class="arabic simple">
<li><p>Come primo passo, costruiremo <a class="reference internal" href="#la-parte-statica"><span class="std std-ref">La parte statica</span></a> dell’applicazione che riguarda la impostazione della pagina HTML.</p></li>
<li><p>Come secondo passo, costruiremo <a class="reference internal" href="#la-parte-dinamica"><span class="std std-ref">La parte dinamica</span></a>, che permette all’applicazione Web di interagire da un lato
con utente umano (attraverso un Browser) e da un altro lato con una applicazione qak, come ad esempio
il sistema <a class="reference internal" href="QakService24Init.html#qakservice24init"><span class="std std-ref">service</span></a> o il  <a class="reference internal" href="BasicRobot24.html#basicrobot24"><span class="std std-ref">BasicRobot24</span></a>.</p></li>
</ol>
<blockquote>
<div><a class="reference internal image-reference" href="_images/Facade24Start0.PNG"><img alt="_images/Facade24Start0.PNG" class="align-center" src="_images/Facade24Start0.PNG" style="width: 60%;" /></a>
</div></blockquote>
<section id="la-parte-statica">
<h2>La parte statica<a class="headerlink" href="#la-parte-statica" title="Permalink to this heading">¶</a></h2>
<p>Anticipiamo qui che per la configurazione della pagina HTML:</p>
<ol class="arabic simple">
<li><p>useremo   <a class="reference external" href="https://www.w3schools.com/bootstrap5/">Bootstrap5</a>, come indicato in <a class="reference internal" href="RobotPosWeb.html#usiamo-bootstrap5"><span class="std std-ref">Usiamo Bootstrap5</span></a></p></li>
<li><p>useramo gli script (da noi deifniti) <a class="reference internal" href="RobotPosWeb.html#ioutils-js"><span class="std std-ref">ioutils.js</span></a> e  <span class="xref std std-ref">wsminimal.js</span>
egli <a class="reference internal" href="RobotPosWeb.html#stili-custom-issspec-css"><span class="std std-ref">Stili custom: issSpec.css</span></a></p></li>
</ol>
</section>
<section id="la-parte-dinamica">
<h2>La parte dinamica<a class="headerlink" href="#la-parte-dinamica" title="Permalink to this heading">¶</a></h2>
<p>Impostiamo l’organizzazione del <a class="reference internal" href="#facadecontroller"><span class="std std-ref">FacadeController</span></a> lato server (<code class="docutils literal notranslate"><span class="pre">Rc</span></code> <em>RemoteController</em> in figura),
evidenziando le seguenti interazioni (supponendo che l’attore applicativo di riferimento
indicato nel file di configurazione <a class="reference internal" href="#facadeconfig-json"><span class="std std-ref">facadeConfig.json</span></a> sia <code class="docutils literal notranslate"><span class="pre">basicrobot</span></code>):</p>
<ol class="arabic">
<li><p><span class="slide3">PgToRc</span>: Realizziamo l’interazione sincrona <span class="blue">Pagina-FacadeController</span>  via HTTP</p></li>
<li><p><span class="slide3">RcToBr</span>: Realizziamo l’interazione <span class="blue">FacadeController-basicrobot</span> usando TCP.</p></li>
<li><p><span class="slide3">BrToRc</span>: Realizziamo l’interazione <span class="blue">basicrobot-FacadeController</span> per far giungere
alla applicazione Web informazioni  sullo stato del sistema.</p></li>
<li><p><span class="slide3">RcToPg</span>: Realizziamo l’interazione asincrona <span class="blue">FacadeController-Pagina</span> per visualizzare sulla pagina HTML
le informazioni sullo stato del sistema, con la mediazione del <a class="reference internal" href="#facadecontroller"><span class="std std-ref">FacadeController</span></a>.</p>
<a class="reference internal image-reference" href="_images/Facade24Start1.PNG"><img alt="_images/Facade24Start1.PNG" class="align-center" src="_images/Facade24Start1.PNG" style="width: 60%;" /></a>
</li>
</ol>
<p>In linea di principio, una pagina HTML potrebbe anche agire come osservatore diretto (via CoAP o MQTT) del <a class="reference internal" href="VirtualRobotUsage24.html#basicrobot"><span class="std std-ref">basicrobot</span></a>.
Tuttavia, notiamo che:</p>
<p><span class="remark">I Browser non supportano API JavaScript per CoAP/MQTT per motivi di sicurezza</span></p>
<p>Questo rende necessario che il <a class="reference internal" href="#facadecontroller"><span class="std std-ref">FacadeController</span></a> funga da mediatore tra le informazioni emesse via CoAP o MQTT da
<a class="reference internal" href="VirtualRobotUsage24.html#basicrobot"><span class="std std-ref">basicrobot</span></a> e la pagina, attraverso le interazioni <code class="docutils literal notranslate"><span class="pre">BrToRc</span></code> e <code class="docutils literal notranslate"><span class="pre">RcToPg</span></code>.</p>
</section>
<section id="fcd24s-startup">
<h2>Fcd24S: startup<a class="headerlink" href="#fcd24s-startup" title="Permalink to this heading">¶</a></h2>
<p>Procedendo in accordo ai <a class="reference internal" href="SpringBootIntro.html#primi-passi-con-springboot"><span class="std std-ref">Primi passi con SpringBoot</span></a> costruiamo uno schema iniziale del progetto
che, in quetsa sede,  <span class="slide2">potrà essere copiato</span> in quanto già opportunamente configurato con dipendenze
a (vecchie) versioni di SpringBoot, allineate con le nostre esigenze.</p>
<ul class="simple">
<li><p>Per i <a class="reference external" href="https://mvnrepository.com/artifact/org.webjars">WebJars</a> si veda <a class="reference internal" href="SpringBootWebSocket.html#bootstrap-e-webjars"><span class="std std-ref">Bootstrap  e webJars</span></a>.</p></li>
</ul>
<section id="enable-springboot-live-devtools">
<h3>Enable SpringBoot live DevTools<a class="headerlink" href="#enable-springboot-live-devtools" title="Permalink to this heading">¶</a></h3>
<p>La feature di auto-restart mediante <em>Spring Developer Tools</em> non sembra abilitata di default
in Intellij   (come avviene invece in Eclipse).</p>
<ul class="simple">
<li><p>Per provare ad attivare manualmente questa feature, si consulti la rete, ad esempio :
<a class="reference external" href="https://medium.com/javarevisited/spring-boot-developer-tools-and-intellij-b16c7e5f39e4">https://medium.com/javarevisited/spring-boot-developer-tools-and-intellij-b16c7e5f39e4</a></p></li>
</ul>
</section>
</section>
<section id="fcd24s-vista-interna">
<h2>Fcd24S: vista interna<a class="headerlink" href="#fcd24s-vista-interna" title="Permalink to this heading">¶</a></h2>
<p>L’organizzazione interna della Facade si compone di oggetti Java, che vengono creati a partire dal
componente <a class="reference internal" href="#facadecontroller"><span class="std std-ref">FacadeController</span></a>, che demanda a <a class="reference internal" href="#facadebuilder"><span class="std std-ref">FacadeBuilder</span></a> la creazione di tutti i componenti del sistema</p>
<table class="docutils align-default" style="width: 100%">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><cite>FacadeBuilder</cite>
crea e configura gli altri componenti del sistema</p></td>
<td><a class="reference internal image-reference" href="_images/Facade24StartCreation.PNG"><img alt="_images/Facade24StartCreation.PNG" class="align-center" src="_images/Facade24StartCreation.PNG" style="width: 100%;" /></a>
</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><a class="reference internal" href="#websocketconfiguration"><span class="std std-ref">WebSocketConfiguration</span></a>  è il componente che abilita le ws in Spring e che viene creato
subito dal configuratore di SpringBoot</p></li>
<li><p><a class="reference internal" href="#facadecontroller"><span class="std std-ref">FacadeController</span></a> dà la pagina iniziale.
Il suo costruttore crea <a class="reference internal" href="#facadebuilder"><span class="std std-ref">FacadeBuilder</span></a>.</p></li>
</ul>
<p><span class="slide1">Principi architetturali</span></p>
<ul class="simple">
<li><p>Molti componenti ovviamente nascono perchè voluti dal framework <a class="reference internal" href="SpringBootIntro.html#springbootintro"><span class="std std-ref">SpringBoot</span></a>.</p></li>
<li><p>La presenza di <a class="reference internal" href="#applguicore"><span class="std std-ref">ApplguiCore</span></a> e di <a class="reference internal" href="#actoroutin"><span class="std std-ref">ActorOutIn</span></a> è invece legata ai <span class="slide2">principi</span>
<a class="reference internal" href="Principi.html#id1"><span class="std std-ref">SOLID</span></a> de <a class="reference internal" href="Architetture.html#la-clean-architecture"><span class="std std-ref">La Clean Architecture</span></a>: i  metodi dell’adapter` <a class="reference internal" href="#actoroutin"><span class="std std-ref">ActorOutIn</span></a>
usato da <a class="reference internal" href="#applguicore"><span class="std std-ref">ApplguiCore</span></a> sono quelli richiesti dall’<a class="reference internal" href="#applguicore"><span class="std std-ref">ApplguiCore</span></a> stessa
per interagire con il mondo esterno.</p></li>
</ul>
<p>La costruzione della Facade adotta il seguente schema:</p>
<ul class="simple">
<li><p>la Facade costituisce un <strong>(sotto)sistema autonomo</strong>, che si relaziona con il sistema applicativo comunicando con
l’attore <code class="docutils literal notranslate"><span class="pre">&lt;actorName&gt;</span></code></p></li>
<li><p>le interazioni tra il sistema applicativo e la Facade avvegono  via <a class="reference internal" href="RaspberrySoftware.html#websocket"><span class="std std-ref">websocket</span></a></p></li>
<li><p>la Facade è costruita in <a class="reference internal" href="SpringBootIntro.html#springbootintro"><span class="std std-ref">SpringBoot</span></a>.
Il suo <a class="reference internal" href="#facadecontroller"><span class="std std-ref">FacadeController</span></a> fornisce solo la pagina iniziale
composta da una area di input e una area di output</p></li>
<li><p>la parte che realizza e gestisce l’input deve essere ridefinita per ogni diversa applicazione, mentre la parte
che realizza  e gestisce l’output può essere considerata invariante</p></li>
<li><p>la interazione con l’attore <code class="docutils literal notranslate"><span class="pre">&lt;actorName&gt;</span></code> del sistema applicativo avviene in due modi:</p>
<ul>
<li><p>usando una connessione TCP (si veda <a class="reference internal" href="#actoroutin"><span class="std std-ref">ActorOutIn</span></a>) al contesto dell’attore, usata per inviare all’attore
le richieste di input. La risposta viene visualizzata nell’area di output (si veda <a class="reference internal" href="#applguicore"><span class="std std-ref">updateMsg</span></a>);</p></li>
<li><p>osservando via CoAP (si veda <a class="reference internal" href="#coapobserver"><span class="std std-ref">CoapObserver</span></a>)  le informazioni inviate dall’attore
usando la primitiva <a class="reference internal" href="QakActors24.html#operazioni-relative-alla-osservabilita"><span class="std std-ref">updateResource</span></a>,
che vengono visualizzati nell’area di output.</p></li>
</ul>
</li>
</ul>
<p>La costruzione della Facade inizia dal
<a class="reference internal" href="#customcontainer"><span class="std std-ref">CustomContainer</span></a>, che invoca <a class="reference internal" href="#applsysteminfo"><span class="std std-ref">ApplSystemInfo.readConfig()</span></a> che legge
il file <a class="reference internal" href="#facadeconfig-json"><span class="std std-ref">facadeConfig.json</span></a>, che include le informazioni necessarie per la configurazione della Facade</p>
<section id="facadeconfig-json">
<h3>facadeConfig.json<a class="headerlink" href="#facadeconfig-json" title="Permalink to this heading">¶</a></h3>
<p>Il file <a class="reference internal" href="#facadeconfig-json"><span class="std std-ref">facadeConfig.json</span></a> fissa i valori di variabili che danno le informazioni sul sistena. Ad esempio:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;host&quot;</span><span class="p">:</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span><span class="s2">&quot;8020&quot;</span><span class="p">,</span>                   <span class="o">//</span><span class="n">qak</span> <span class="n">application</span> <span class="n">node</span>
 <span class="s2">&quot;context&quot;</span><span class="p">:</span><span class="s2">&quot;ctxbasicrobot&quot;</span><span class="p">,</span> <span class="s2">&quot;facade&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;actorname&gt;&quot;</span><span class="p">,</span>  <span class="o">//</span><span class="n">qak</span> <span class="n">actor</span> <span class="n">di</span> <span class="n">riferimento</span> <span class="n">e</span> <span class="n">suo</span> <span class="n">contesto</span>
 <span class="s2">&quot;facadeport&quot;</span><span class="p">:</span><span class="s2">&quot;8085&quot;</span><span class="p">,</span>                                 <span class="o">//</span><span class="n">port</span> <span class="n">della</span> <span class="n">Facade</span> <span class="n">come</span> <span class="n">Web</span> <span class="n">application</span>
 <span class="s2">&quot;sysdescr&quot;</span><span class="p">:</span><span class="s2">&quot;basicrobot24&quot;</span>                            <span class="o">//</span><span class="n">file</span> <span class="o">.</span><span class="n">pl</span> <span class="n">che</span> <span class="n">contiene</span> <span class="n">la</span> <span class="n">descrizione</span> <span class="k">del</span> <span class="n">sistema</span> <span class="n">qak</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Il file viene letto usando <a class="reference internal" href="#qaksysconfigsupport"><span class="std std-ref">QaksysConfigSupport</span></a> che setta variabili contenute nella classe
<a class="reference internal" href="#applsysteminfo"><span class="std std-ref">ApplSystemInfo</span></a> che funge da base di conoscenza (Java) sul sistema.</p>
</section>
</section>
<section id="fcd24s-interazioni">
<h2>Fcd24S: interazioni<a class="headerlink" href="#fcd24s-interazioni" title="Permalink to this heading">¶</a></h2>
<p>La figura che segue mostra le interazioni con riferimento alla qak-applicazione <a class="reference internal" href="QakService24Init.html#qakservice24init"><span class="std std-ref">servicemath</span></a></p>
<a class="reference internal image-reference" href="_images/Facade24Inside.PNG"><img alt="_images/Facade24Inside.PNG" class="align-center" src="_images/Facade24Inside.PNG" style="width: 100%;" /></a>
<a class="reference internal image-reference" href="_images/Facade24CoapObs.PNG"><img alt="_images/Facade24CoapObs.PNG" class="align-center" src="_images/Facade24CoapObs.PNG" style="width: 80%;" /></a>
<section id="fcd24s-funzionamento">
<h3>Fcd24S: funzionamento<a class="headerlink" href="#fcd24s-funzionamento" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Un client (diciamo <strong>clientMaster</strong>)  esegue <a class="reference external" href="http://localhost:8085">http://localhost:8085</a>. La pagina può essere aperta anche da altri nodi.</p></li>
<li><p><a class="reference internal" href="#facadecontroller"><span class="std std-ref">FacadeController</span></a> restituisce pagina HTML che include gli script <a class="reference internal" href="RobotPosWeb.html#ioutils-js"><span class="std std-ref">ioutils.js</span></a> e <a class="reference internal" href="#wsminimal-js"><span class="std std-ref">wsminimal.js</span></a></p></li>
<li><p>il <strong>clientMaster</strong> preme  uno dei pulsanti presentati dalla GUI per inviare un comando (dispatch) o una richiesta (request)
all’ppliazione qak</p></li>
<li><p>il server esegue <code class="docutils literal notranslate"><span class="pre">handleTextMessage</span></code>  di <a class="reference internal" href="#wshandler"><span class="std std-ref">WSHandler</span></a> che chiama <code class="docutils literal notranslate"><span class="pre">handleWsMsg</span></code> di <a class="reference internal" href="#applguicore"><span class="std std-ref">ApplguiCore</span></a>
che chiama <code class="docutils literal notranslate"><span class="pre">dorequest</span></code> di <a class="reference internal" href="#actoroutin"><span class="std std-ref">ActorOutIn</span></a> che confeziona un <strong>IApplMessage msg</strong> e chiama
<code class="docutils literal notranslate"><span class="pre">sendToActor(IApplMessage</span> <span class="pre">message,</span> <span class="pre">String</span> <span class="pre">requestId)</span></code> che fa <code class="docutils literal notranslate"><span class="pre">tcpConn.request(message)</span></code> SINCRONA, attendendo
la risposta</p></li>
<li><p>quando l’attrore applicativo <code class="docutils literal notranslate"><span class="pre">&lt;actorName&gt;</span></code> invia la risposta, <a class="reference internal" href="#actoroutin"><span class="std std-ref">ActorOutIn</span></a> esegue
<code class="docutils literal notranslate"><span class="pre">handleReplyMsg</span></code> di <a class="reference internal" href="#applguicore"><span class="std std-ref">ApplguiCore</span></a> che gestisce la risposta chimando  <code class="docutils literal notranslate"><span class="pre">sendToAll(..)</span></code> di <a class="reference internal" href="#actoroutin"><span class="std std-ref">ActorOutIn</span></a>
che chiama   <code class="docutils literal notranslate"><span class="pre">sendToAll(..)</span></code> di <a class="reference internal" href="#wshandler"><span class="std std-ref">WSHandler</span></a> per aggiornare tutte le pagine connesse,
tra cui quella del <strong>clientMaster</strong>.</p></li>
<li><p><a class="reference internal" href="RobotPosWeb.html#ioutils-js"><span class="std std-ref">ioutils.js</span></a> della pagina HTML di ogni client esegue <code class="docutils literal notranslate"><span class="pre">socket.onmessage</span></code> e quindi visualizza il messaggio
ricevuto via websocket nell’area di output.</p></li>
</ol>
</section>
</section>
<section id="facade24-i-componenti">
<h2>Facade24: i componenti<a class="headerlink" href="#facade24-i-componenti" title="Permalink to this heading">¶</a></h2>
<p>Si riporta nel seguito l’elenco dei componenti interni di Facade24, con qualche elemento di codice,
lasciando i dettagli alla consultazione dei files sorgente nel progetto.</p>
<section id="customcontainer">
<h3>CustomContainer<a class="headerlink" href="#customcontainer" title="Permalink to this heading">¶</a></h3>
<p>Crea <a class="reference internal" href="#applsysteminfo"><span class="std std-ref">ApplSystemInfo</span></a> e  fissa il nome della applicazione al valore
<code class="docutils literal notranslate"><span class="pre">ApplSystemInfo.appName</span></code>, , che viene riportata nella
pagina HTML attraverso l’attributo <code class="docutils literal notranslate"><span class="pre">&quot;appname&quot;</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">CustomContainer</span> <span class="n">implements</span>
    <span class="n">WebServerFactoryCustomizer</span><span class="o">&lt;</span><span class="n">ConfigurableServletWebServerFactory</span><span class="o">&gt;</span>

    <span class="n">ApplSystemInfo</span><span class="o">.</span><span class="n">readConfig</span><span class="p">();</span>
    <span class="nb">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ApplSystemInfo</span><span class="o">.</span><span class="n">facadeport</span><span class="p">;</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">setPort</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>  <span class="o">//</span><span class="n">customization</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">customize</span><span class="p">(</span><span class="n">ConfigurableServletWebServerFactory</span> <span class="n">factory</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="applsysteminfo">
<h3>ApplSystemInfo<a class="headerlink" href="#applsysteminfo" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="#customcontainer"><span class="std std-ref">CustomContainer</span></a> crea un oggetto di questa classe, che
legge il file <a class="reference internal" href="#facadeconfig-json"><span class="std std-ref">facadeConfig.json</span></a> (usando <a class="reference internal" href="#qaksysconfigsupport"><span class="std std-ref">QaksysConfigSupport</span></a>)
e fissa i valori di variabili che danno le informazioni sul sistena:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">static</span> <span class="n">String</span> <span class="n">qakSysHost</span><span class="p">;</span>
<span class="n">public</span> <span class="n">static</span> <span class="n">String</span> <span class="n">qakSysPort</span><span class="p">;</span>
<span class="n">public</span> <span class="n">static</span> <span class="n">String</span> <span class="n">qakSysCtx</span><span class="p">;</span>
<span class="n">public</span> <span class="n">static</span> <span class="n">String</span> <span class="n">applActorName</span><span class="p">;</span>
<span class="n">public</span> <span class="n">static</span> <span class="n">String</span> <span class="n">ctxportStr</span><span class="p">;</span>
<span class="n">public</span> <span class="n">static</span> <span class="nb">int</span> <span class="n">ctxport</span><span class="p">;</span>
<span class="n">public</span> <span class="n">static</span> <span class="n">String</span> <span class="n">facadeportStr</span><span class="p">;</span>
<span class="n">public</span> <span class="n">static</span> <span class="nb">int</span> <span class="n">facadeport</span><span class="p">;</span>
<span class="n">public</span> <span class="n">static</span> <span class="n">String</span> <span class="n">appName</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="qaksysconfigsupport">
<h3>QaksysConfigSupport<a class="headerlink" href="#qaksysconfigsupport" title="Permalink to this heading">¶</a></h3>
<p>Utility per leggere i valori del file  <a class="reference internal" href="#facadeconfig-json"><span class="std std-ref">facadeConfig.json</span></a>
.. code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">QaksysConfigSupport</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">readConfig</span><span class="p">(</span> <span class="n">String</span> <span class="n">fName</span> <span class="p">)</span>
    <span class="n">protected</span> <span class="n">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">readTheContent</span><span class="p">(</span> <span class="n">String</span> <span class="n">config</span> <span class="p">)</span> <span class="n">throws</span> <span class="n">JSONException</span>
</pre></div>
</div>
</section>
<section id="facadecontroller">
<h3>FacadeController<a class="headerlink" href="#facadecontroller" title="Permalink to this heading">¶</a></h3>
<p>Questo componente restituisce semplicemente la pagina <span class="xref std std-ref">qakFacadeGui.html</span>. Tutte le interazioni col server
saranno via WebSocket.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">FacadeController</span>
 <span class="n">protected</span> <span class="n">ApplSystemInfo</span> <span class="n">qakSys</span><span class="p">;</span>

    <span class="n">private</span> <span class="n">void</span> <span class="n">updateViewmodel</span><span class="p">(</span><span class="n">Model</span> <span class="n">model</span><span class="p">,</span> <span class="n">String</span> <span class="n">info</span> <span class="p">)</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">public</span> <span class="n">String</span> <span class="n">homePage</span><span class="p">(</span><span class="n">Model</span> <span class="n">viewmodel</span><span class="p">){</span>
        <span class="n">viewmodel</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="s2">&quot;appname&quot;</span><span class="p">,</span> <span class="n">ApplSystemInfo</span><span class="o">.</span><span class="n">appName</span><span class="p">);</span>
        <span class="k">return</span> <span class="s2">&quot;qakFacadeGUI&quot;</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="facadebuilder">
<h3>FacadeBuilder<a class="headerlink" href="#facadebuilder" title="Permalink to this heading">¶</a></h3>
<p>Componente che crea e configura gli oggetti-componenti della Facade:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#wshandler"><span class="std std-ref">WSHandler</span></a> che opera come gestore dei messaggi su WS</p></li>
<li><p><a class="reference internal" href="#applguicore"><span class="std std-ref">ApplguiCore</span></a> che contiene la logica applicativa (domain core) della gui</p></li>
<li><p><a class="reference internal" href="#actoroutin"><span class="std std-ref">ActorOutIn</span></a> che lavora come Adapter verso l’attore <code class="docutils literal notranslate"><span class="pre">&lt;actorName&gt;</span></code> descritto nel file <a class="reference internal" href="#facadeconfig-json"><span class="std std-ref">facadeConfig.json</span></a>.</p></li>
<li><p><a class="reference internal" href="#coapobserver"><span class="std std-ref">CoapObserver</span></a> che crea un client-observer CoAP verso l’attore <code class="docutils literal notranslate"><span class="pre">&lt;actorName&gt;</span></code></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wsHandler</span>    <span class="o">=</span> <span class="n">new</span> <span class="n">WSHandler</span><span class="p">();</span>
<span class="n">outinadapter</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ActorOutIn</span><span class="p">(</span> <span class="n">wsHandler</span> <span class="p">);</span>
<span class="n">guiCore</span>      <span class="o">=</span> <span class="n">new</span> <span class="n">ApplguiCore</span><span class="p">(</span><span class="n">outinadapter</span><span class="p">);</span>

<span class="n">outinadapter</span><span class="o">.</span><span class="n">setGuiCore</span><span class="p">(</span><span class="n">guiCore</span><span class="p">);</span> <span class="o">//</span><span class="n">Injection</span>
<span class="n">wsHandler</span><span class="o">.</span><span class="n">setGuiCore</span><span class="p">(</span><span class="n">guiCore</span><span class="p">);</span> <span class="o">//</span><span class="n">Injection</span>
</pre></div>
</div>
<p>L’<strong>injection</strong> è necessaria per via del’ordine di costruzione e della mutua referenza.</p>
</section>
<section id="websocketconfiguration">
<h3>WebSocketConfiguration<a class="headerlink" href="#websocketconfiguration" title="Permalink to this heading">¶</a></h3>
<p>Questo componente è richiesto da <a class="reference internal" href="SpringBootIntro.html#springbootintro"><span class="std std-ref">SpringBoot</span></a> per la gestione delle ws
(tramite <a class="reference internal" href="#wshandler"><span class="std std-ref">WSHandler</span></a> creato da  <a class="reference internal" href="#facadebuilder"><span class="std std-ref">FacadeBuilder</span></a>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocket</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">WebSocketConfiguration</span> <span class="n">implements</span> <span class="n">WebSocketConfigurer</span>

<span class="n">public</span> <span class="n">final</span> <span class="n">String</span> <span class="n">wsPath</span>  <span class="o">=</span> <span class="s2">&quot;/accessgui&quot;</span><span class="p">;</span>

<span class="nd">@Override</span>
<span class="n">public</span> <span class="n">void</span> <span class="n">registerWebSocketHandlers</span><span class="p">(</span><span class="n">WebSocketHandlerRegistry</span> <span class="n">registry</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">registry</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">FacadeBuilder</span><span class="o">.</span><span class="n">wsHandler</span><span class="p">,</span> <span class="n">wsPath</span><span class="p">)</span><span class="o">.</span><span class="n">setAllowedOrigins</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="wshandler">
<h3>WSHandler<a class="headerlink" href="#wshandler" title="Permalink to this heading">¶</a></h3>
<p>Gestore delle interazioni via WebSocket.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">WSHandler</span> <span class="n">extends</span> <span class="n">AbstractWebSocketHandler</span>
<span class="n">private</span> <span class="n">ApplguiCore</span> <span class="n">guiCore</span><span class="p">;</span>

  <span class="o">//</span><span class="n">Injiection</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">setGuiCore</span><span class="p">(</span><span class="n">ApplguiCore</span> <span class="n">gui</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">guiCore</span> <span class="o">=</span> <span class="n">gui</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="n">protected</span> <span class="n">void</span> <span class="n">handleTextMessage</span><span class="p">(</span> <span class="n">WebSocketSession</span> <span class="n">session</span><span class="p">,</span><span class="n">TextMessage</span> <span class="n">message</span><span class="p">)</span>
    <span class="n">guiCore</span><span class="o">.</span><span class="n">handleWsMsg</span><span class="p">(</span> <span class="n">msg</span> <span class="p">);</span>

  <span class="n">protected</span> <span class="n">synchronized</span>  <span class="n">void</span> <span class="n">sendToAll</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">WebSocketSession</span> <span class="n">session</span> <span class="p">:</span> <span class="n">sessions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">session</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">new</span> <span class="n">TextMessage</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Il metodo <code class="docutils literal notranslate"><span class="pre">sendToAll</span></code> è <strong>synchronized</strong> perchè vi possono essere chiamate concorrenti da
<a class="reference internal" href="#applguicore"><span class="std std-ref">ApplguiCore</span></a> e <a class="reference internal" href="#coapobserver"><span class="std std-ref">CoapObserver</span></a>.</p>
</section>
<section id="applguicore">
<h3>ApplguiCore<a class="headerlink" href="#applguicore" title="Permalink to this heading">¶</a></h3>
<p>Rappreesenta il <span class="slide1">core business</span> della Facade, che ha la responsabilità di decidere cosa fare
per ogni messaggio di input e come inviare informazioni in uscita attraverso l’adapter
<a class="reference internal" href="#actoroutin"><span class="std std-ref">ActorOutIn</span></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">ApplguiCore</span>
<span class="n">private</span>   <span class="n">ActorOutIn</span> <span class="n">outinadapter</span><span class="p">;</span>

<span class="n">public</span> <span class="n">ApplguiCore</span><span class="p">(</span> <span class="n">ActorOutIn</span> <span class="n">outinadapter</span> <span class="p">){</span>
     <span class="n">this</span><span class="o">.</span><span class="n">outinadapter</span> <span class="o">=</span> <span class="n">outinadapter</span><span class="p">;</span>
     <span class="n">destActor</span>         <span class="o">=</span> <span class="n">ApplSystemInfo</span><span class="o">.</span><span class="n">applActorName</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">public</span> <span class="n">void</span> <span class="n">hanldeMsgFromActor</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">,</span> <span class="n">String</span> <span class="n">requestId</span><span class="p">)</span>
   <span class="n">updateMsg</span><span class="p">(</span> <span class="n">msg</span> <span class="p">);</span>
<span class="n">protected</span> <span class="n">void</span> <span class="n">updateMsg</span><span class="p">(</span> <span class="n">String</span> <span class="n">msg</span> <span class="p">)</span>
    <span class="n">outinadapter</span><span class="o">.</span><span class="n">sendToAll</span><span class="p">(</span> <span class="n">msg</span>  <span class="p">);</span>
<span class="n">public</span> <span class="n">void</span> <span class="n">handleWsMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">,</span> <span class="n">String</span> <span class="n">msgId</span><span class="p">)</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">request</span><span class="o">/</span><span class="mi">20</span> <span class="n">che</span> <span class="n">chiama</span><span class="p">:</span>
  <span class="o">//</span><span class="n">isola</span> <span class="n">il</span> <span class="n">payload</span> <span class="mi">20</span> <span class="n">dal</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">request</span><span class="o">/</span><span class="mi">20</span> <span class="n">e</span> <span class="n">poi</span> <span class="n">chiama</span>

  <span class="n">private</span> <span class="n">void</span> <span class="n">dorequest</span><span class="p">(</span> <span class="n">String</span> <span class="n">payload</span> <span class="p">)</span>
    <span class="n">outinadapter</span><span class="o">.</span><span class="n">dorequest</span><span class="p">(</span>
       <span class="s2">&quot;gui&quot;</span><span class="p">,</span><span class="n">destActor</span><span class="p">,</span><span class="n">reqid</span><span class="p">,</span><span class="n">reqcontent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
</section>
<section id="actoroutin">
<h3>ActorOutIn<a class="headerlink" href="#actoroutin" title="Permalink to this heading">¶</a></h3>
<p>Crea la connessione TCP all’attore <code class="docutils literal notranslate"><span class="pre">&lt;actorName&gt;</span></code> del sistema applicativo</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">ActorOutIn</span>
    <span class="n">public</span> <span class="n">ActorOutIn</span><span class="p">(</span><span class="n">WSHandler</span> <span class="n">wsHandler</span> <span class="p">)</span>
        <span class="n">crea</span> <span class="n">tcpConn</span> <span class="nb">all</span><span class="s1">&#39;actor di Facade</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">dorequest</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span> <span class="p">)</span>
      <span class="n">IApplMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">CommUtils</span><span class="o">.</span><span class="n">buildRequest</span><span class="p">(</span><span class="n">senderId</span><span class="p">,</span> <span class="n">reqid</span><span class="p">,</span> <span class="n">reqarg</span>  <span class="p">,</span> <span class="n">destActor</span><span class="p">);</span>
      <span class="n">sendToActor</span><span class="p">(</span> <span class="n">message</span> <span class="p">);</span>
    <span class="n">private</span> <span class="n">void</span> <span class="n">sendToActor</span><span class="p">(</span> <span class="n">IApplMessage</span> <span class="n">message</span> <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="coapobserver">
<h3>CoapObserver<a class="headerlink" href="#coapobserver" title="Permalink to this heading">¶</a></h3>
<p>Osserva l’attore  <code class="docutils literal notranslate"><span class="pre">&lt;actorName&gt;</span></code> da cui riceve le informazioni inviate da
<a class="reference internal" href="QakActors24.html#operazioni-relative-alla-osservabilita"><span class="std std-ref">updateResource</span></a> e le
invia a <em>hanldeMsgFromActor</em> di <a class="reference internal" href="#applguicore"><span class="std std-ref">ApplguiCore</span></a> che le pubblica su tutte le pagine connesse usando
<a class="reference internal" href="#wshandler"><span class="std std-ref">WSHandler</span></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">CoapObserver</span> <span class="n">implements</span> <span class="n">CoapHandler</span>

<span class="n">public</span> <span class="n">CoapObserver</span><span class="p">(</span><span class="n">ApplguiCore</span> <span class="n">guiCore</span><span class="p">,</span> <span class="n">String</span> <span class="n">actor</span><span class="p">)</span>

<span class="nd">@Override</span>
<span class="n">public</span> <span class="n">void</span> <span class="n">onLoad</span><span class="p">(</span><span class="n">CoapResponse</span> <span class="n">response</span><span class="p">)</span>
  <span class="n">guiCore</span><span class="o">.</span><span class="n">hanldeMsgFromActor</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">getResponseText</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="nd">@Override</span>
<span class="n">public</span> <span class="n">void</span> <span class="n">onError</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="wsminimal-js">
<h3>wsminimal.js<a class="headerlink" href="#wsminimal-js" title="Permalink to this heading">¶</a></h3>
<p>Codice JavaScript inserito nella pagina HTML per interagire con il server via WebSocket.</p>
</section>
<section id="ioutils-js">
<h3>ioutils.js<a class="headerlink" href="#ioutils-js" title="Permalink to this heading">¶</a></h3>
<p>Codice JavaScript inserito nella pagina HTML per inviare al server comandi e richieste, usando Ajax.</p>
</section>
</section>
<section id="fcd24s-sperimentazione">
<h2>Fcd24S: sperimentazione<a class="headerlink" href="#fcd24s-sperimentazione" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Attivare il VirtualRobot  (VR)</p></li>
<li><p>Posizionarsi sulla direcory <span class="high">unibo.basicrobot24</span>
ed attivare il basic robot con il comando <span class="high">gradlew run</span> (osservare il movimento del VR)</p></li>
<li><p>Posizionarsi sulla directory <span class="high">Facade24Start</span> ed eseguire <span class="high">gradlew bootRun</span></p></li>
<li><p>Aprire un browser all’indirizzo <a class="reference external" href="http://localhost:8085">http://localhost:8085</a></p></li>
</ol>
<section id="la-pagina-html">
<h3>La pagina HTML<a class="headerlink" href="#la-pagina-html" title="Permalink to this heading">¶</a></h3>
<p>La pagina HTML che compare: <a class="reference external" href="../../../../Facade24Start/src/main/resources/templates/Fcd24SGUI.html">Fcd24SGUI.html</a></p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Facade24Start</a><ul>
<li><a class="reference internal" href="#la-parte-statica">La parte statica</a></li>
<li><a class="reference internal" href="#la-parte-dinamica">La parte dinamica</a></li>
<li><a class="reference internal" href="#fcd24s-startup">Fcd24S: startup</a><ul>
<li><a class="reference internal" href="#enable-springboot-live-devtools">Enable SpringBoot live DevTools</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fcd24s-vista-interna">Fcd24S: vista interna</a><ul>
<li><a class="reference internal" href="#facadeconfig-json">facadeConfig.json</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fcd24s-interazioni">Fcd24S: interazioni</a><ul>
<li><a class="reference internal" href="#fcd24s-funzionamento">Fcd24S: funzionamento</a></li>
</ul>
</li>
<li><a class="reference internal" href="#facade24-i-componenti">Facade24: i componenti</a><ul>
<li><a class="reference internal" href="#customcontainer">CustomContainer</a></li>
<li><a class="reference internal" href="#applsysteminfo">ApplSystemInfo</a></li>
<li><a class="reference internal" href="#qaksysconfigsupport">QaksysConfigSupport</a></li>
<li><a class="reference internal" href="#facadecontroller">FacadeController</a></li>
<li><a class="reference internal" href="#facadebuilder">FacadeBuilder</a></li>
<li><a class="reference internal" href="#websocketconfiguration">WebSocketConfiguration</a></li>
<li><a class="reference internal" href="#wshandler">WSHandler</a></li>
<li><a class="reference internal" href="#applguicore">ApplguiCore</a></li>
<li><a class="reference internal" href="#actoroutin">ActorOutIn</a></li>
<li><a class="reference internal" href="#coapobserver">CoapObserver</a></li>
<li><a class="reference internal" href="#wsminimal-js">wsminimal.js</a></li>
<li><a class="reference internal" href="#ioutils-js">ioutils.js</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fcd24s-sperimentazione">Fcd24S: sperimentazione</a><ul>
<li><a class="reference internal" href="#la-pagina-html">La pagina HTML</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="BasicRobot24.html"
                          title="previous chapter">BasicRobot24</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="RobotFacade24.html"
                          title="next chapter">RobotFacade24</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Facade24Start.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="RobotFacade24.html" title="RobotFacade24"
             >next</a> |</li>
        <li class="right" >
          <a href="BasicRobot24.html" title="BasicRobot24"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">iss24 1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Facade24Start</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2024, Antonio Natali.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>